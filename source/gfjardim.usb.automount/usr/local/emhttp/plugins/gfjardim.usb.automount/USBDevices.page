Menu="Main:4"
Title="USB Devices"
Cond="( count(preg_grep('/.*(usb).*?-part\d+/i', array_diff(scandir('/dev/disk/by-path'), array('.','..')))) > 1 )"
Markdown="false"
---
<?PHP
$plugin = "gfjardim.usb.automount";
require_once("/usr/local/emhttp/plugins/${plugin}/include/usb_mount_lib.php");
?>
<link type='text/css' rel='stylesheet' href='/webGui/styles/jquery.switchButton.css'>
<link type="text/css" rel="stylesheet" href="/webGui/styles/jquery-ui.min.css">
<link rel="stylesheet" type="text/css" href="/plugins/<?=$plugin;?>/assets/waitMe.min.css">
<style>
  table.usb_disks{border-collapse:collapse;white-space:nowrap;}
  table.usb_disks td span{margin-left:10px;}
  table.usb_disks thead tr:first-child td{font-size:13px;background:-webkit-radial-gradient(#E0E0E0,#C0C0C0);background:linear-gradient(#E0E0E0,#C0C0C0);}
  table.usb_disks tr>td{text-align:center;width:8%;padding-left:12px;padding-right:0;white-space:nowrap;}
  table.usb_disks tr>td+td{text-align:left;width:auto;}
  table.usb_disks tr>td+td+td+td{text-align:right;padding-left:0;padding-right:12px;}
  table.usb_disks tr>td+td+td+td+td+td+td+td+td{text-align:center;padding-left:0;padding-right:12px;}
  table.usb_disks tr>td+td+td+td+td+td+td+td+td+td{text-align:left;padding-left:0;padding-right:12px;width: 5em;}
  table.usb_disks tr>td+td+td+td+td+td+td+td+td+td+td{text-align:right;}
  table.usb_disks tbody tr:nth-child(even){background-color:#F8F8F8;}

  table.usb_absent{border-collapse:collapse;white-space:nowrap;}
  table.usb_absent td span{margin-left:10px;}
  table.usb_absent thead tr:first-child td{font-size:13px;background:-webkit-radial-gradient(#E0E0E0,#C0C0C0);background:linear-gradient(#E0E0E0,#C0C0C0);}
  table.usb_absent tr>td{text-align:center;width:8%;padding-left:12px;padding-right:0;white-space:nowrap;}
  table.usb_absent tr>td+td{text-align:left;width:auto;}
  table.usb_absent tr>td+td+td+td+td{text-align:right;padding-left:0;padding-right:12px;width: 5em;}
  table.usb_absent tbody tr:nth-child(even){background-color:#F8F8F8;}
  .switch-button-background {margin: 0px 0px;}
</style>
<script type="text/javascript" src="/webGui/scripts/jquery.switchButton.js"></script>
<script type="text/javascript" src="/plugins/<?=$plugin;?>/assets/waitMe.min.js"></script>
<script type="text/javascript">
  function usb_mount(cmd){
    $('#usb_devices_list').waitMe({effect:'ios',text:' ',bg:'rgba(255,255,255,0.7)',color:'#000',sizeW:'',sizeH:'',source:''});
    $.post('/update.php',{'#command':cmd});
  }
  function pin_tab(n) {
    $.removeCookie('one',{path:'/'});
    $.cookie('tab','tab'+n,{path:'/'});
  }
  function usb_disks(tabnum) {
    if ($('#tab'+tabnum).is(':checked') && ! detect_usb_disk_change(tabnum)) {
      $('#usb_devices_list').waitMe({effect:'ios',text:' ',bg:'rgba(255,255,255,0.7)',color:'#000',sizeW:'',sizeH:'',source:''});
      $.post('/plugins/<?=$plugin;?>/USBDevicesList.php',{action:"get_content"},function(data) {
        if (data) $('#usb_devices_list').html(data);
      });
    }
  }
  function detect_usb_disk_change() {
    if ($('#tab'+tab_usbdisks).is(':checked')) {
      clearTimeout(timers.usbdisks);
      timers.usbdisks = setTimeout(detect_usb_disk_change,2000);
      $.post('/plugins/<?=$plugin;?>/USBDevicesList.php',{action:"detect"},function(data) {
        if(data.reload){usb_disks(tab_usbdisks);return true;}
      },"json");
    } else {
      clearTimeout(timers.usbdisks);
    }
    return false;
  }
  function remove_disk_config(serial) {
    $.post("/plugins/<?=$plugin;?>/update_cfg.php",{action:"remove_config",serial:serial},"json");
    usb_disks(tab_usbdisks);
  }
  
  tab_usbdisks = $('input[name$="tabs"]').length;
  $('#tab'+tab_usbdisks).bind({click:function() {pin_tab(tab_usbdisks); usb_disks(tab_usbdisks);}});
  $(function(){usb_disks(tab_usbdisks);});

</script>
 
<form id="formUsbMount" method="POST" action="/update.php" target="progressFrame">
  <input type="hidden" id="cmdUsbMount" name="#command" value="" />
</form>

<div id="dialog-confirm" style="display:none;" title="Dialog Title">
  <input type="text" id="input_command_field"> 
</div>

<div id="usb_devices_list" style="height:auto;min-height:200px;"></div>


